# 批处理笔记总结



## 批处理命令整理

### cmd的基本命令

#### 文件夹管理

| 命令  | 作用                               |
| ----- | ---------------------------------- |
| cls   | 清屏                               |
| cd    | 显示当前目录名或改变当前目录       |
| md    | 创建目录                           |
| rd    | 删除一个目录                       |
| dir   | 显示目录中的文件和子目录列表       |
| tree  | 以图形显示驱动器或路径的文件夹结构 |
| path  | 为可执行文件显示或设置一个搜索路径 |
| xcopy | 复制文件和目录树                   |



#### 文件管理

| 命令    | 作用                                                        |
| ------ | ----------------------------------------------------------- |
| type    | 显示文本文件的内容                                          |
| copy    | 将一份或多份文件复制到另一个位置                            |
| del     | 删除一个或数个文件                                          |
| move    | 移动文件并重命名文件和目录（Windows XP Home Edition中没有） |
| ren/rename | 重命名文件                                                  |
| replace | 替换文件                                                    |
| attrib  | 显示或更改文件属性                                          |
| find    | 搜索字符串                                                  |
| fc      | 比较两个文件或两个文件集并显示它们之间的不同                |



#### 网络命令

| 命令     | 作用                                      |
| -------- | ----------------------------------------- |
| ping     | 进行网络连接测试、名称解析                |
| ftp      | 文件传输                                  |
| net      | 网络命令集及用户管理                      |
| telnet   | 远程登陆                                  |
| ipconfig | 显示、修改TCP/IP设置                      |
| msg      | 给用户发送消息                            |
| arp      | 显示、修改局域网的IP地址-物理地址映射列表 |



#### 系统管理

| 命令     | 作用                                              |
| -------- | ------------------------------------------------- |
| schtasks | 管理计划任务                                      |
| shutdown | 立即或定时关机或重启                              |
| tskill   | 结束进程                                          |
| taskkill | 结束进程（比tskill高级，但WinXPHome版中无该命令） |
| tasklist | 显示进程列表（Windows XP Home Edition中没有）     |
| sc       | 系统服务设置与控制                                |
| reg      | 注册表控制台工具                                  |
| powercfg | 控制系统上的电源设置                              |





### 批处理的基本命令

> @、echo、::和rem、pause、call、:和goto、setlocal和endlocal、ren

#### @命令

它在批处理中的作用是让系统在执行批处理命令时不显示该行命令本身。通俗一点说，当某一行命令最前面使用了该名，这一行的命令就不在执行过程中显示了。在例一首行的@echo off中，@的作用就是让批处理在执行时不显示后面的echo off部分。



#### echo命令

echo命令是一个开关命令，它只有on和off两中状态，一般出现在批处理第一行中，它的作用是保证批处理在执行时不显示它后面所有命令本身，只显示执行中的结果或其他信息，用法为：`echo [on|off] `。

echo命令和@命令的区别在于前者关闭了所有命令本身，而后者只关闭其中一行。将echo命令和@命令结合起来使用，达到了两个目的：不显示echo off命令本身，不显示以后各行中的命令本身。

echo命令还有其他特别的用法，比如用来在批处理执行过程中显示一段信息，用法为：`ECHO [消息内容]`。



#### ::和rem命令
::和rem命令的作用和用法都完全一样，用来在批处理中做注释，增加程序的可读性。它们的用法很简单，直接将注释内容写到::或rem后面就可以了。

**注意：**如果在for循环中的某句语句后面使用`::`注释并下一行是一个空行，那么for语句可能会被终止，所以建议注释都使用`rem`来注释。



#### pause命令

该命令在批处理中使用十分广泛，其作用是暂停批处理的执行，直到用户按下键盘上的任意键（Break键除外）。批处理在执行过程中显示的所有信息都是一闪而过的，只有当用户暂停执行时，才可以看到当前屏幕上的信息。当程序要让用户看一段信息，或要给用户时间去考虑某个问题的时候，就可以在这里加上一个pause，批处理执行到这里时将显示“按任意键继续”的信息。

用法很简单，直接在要暂停的地方使用pause命令即可。

**提示：**如果要让pause命令执行后的”请按任意键继续“的提示不出现，可以这么写：`pause > nul`。同理其他命令执行后的提示如果不想显示，都可以这么写，在后面跟上 ` >nul`即可。



#### call命令
该命令是用来从一个批处理中调用另一个批处理的，用法为：`CALL [驱动器] [路径] 批处理名 [参数]`。使用此命令，可以实现多个批处理互相调用，类似于程序中各个模块之间的互相调用。例如有两个批处理名分别为01.bat和02.cmd，在01.bat里有如下命令：`call 02.cmd` ，01.bat执行到此句时，自动停止后面命令的执行，而转到执行02.cmd。

**提示：**如果call调用的文件名或文件路径存在空格或其他可能会识别出错的字符，可以将call后面的语句用双引号括起来，例如：`call "c:/program files/1.bat"`。



#### :和goto命令
这是两个成对出现的命令，goto命令的作用是告诉程序并不按顺序向下执行，而是要跳转到另一个地方，而:标识符则唯一标记了goto命令要跳转的地址。简单来说，goto是个跳转命令，而:是一个标签。当程序运行到goto时，将自动跳转到:所标记的地方去执行。

**注意：**goto命令的标签长度不能超过8个字节，否则可能会出错。即`thistest1`和`thistest`的效果是一样的，批处理只取前8个字节`thistest`。

**注意：**goto命令可能会使for语句变得不循环。例如for循环嵌套中`for A(for B(...))`，想从内部的for循环`for B(...)`跳出到外面一层的for循环`for A(...)`，使用goto跳出到外面的循环`for A(...)`后外面的循环将终止循环状态，所以goto并不能起到编程语言中的break功能，反而会让你的for语句出错，解决办法就是将**从内循环的for语句至goto跳出的标签之间的内容**都写在另一个bat文件中，通过call来调用，这样另一个bat文件里的goto就不会对原来的循环起到影响，同时也能起到其他编程语句里的break的效果。



#### setlocal和endlocal命令
这两个命令也是成对出现的，用来对批处理执行过程中的环境变量进行临时修改和操作，当执行过endlocal或关闭批处理后环境变量仍为系统原先设置的值。例如系统环境变量设置了Windows文件夹的目录为`C:\Windows`，而在批处理执行过程中要设置Windows文件夹的目录为`D:\Windows`，这就可以使用设置环境变量的命令在setlocal和endloacl之间进行重新设置。这个设置只限于该批处理执行过程中，是一个临时设置。一般情况下setlocal和endlocal两个命令在批处理中使用并不广泛。



#### ren命令
ren是“rename（重命名）”的简写，例如把一个文件夹中的很多txt文件改为sql文件：`ren *.txt *.sql`
命令格式：

```powershell
REN [Drive:] [path] <old filename> <new filename>
[Drive:][path]:文件所在的路径
<old filename>:你所要修改的文件名称
<new filename>:你所要修改成的新名称```
```



#### set命令
显示、设置或删除变量。

`例子：set stringName=`	这段代码可以定义一个没有任何初始值的环境变量。
`例子：set /p stringName=请输入字符串`	这段代码，就是给之前定义的变量设置我们从键盘输入的字符串了。
`例子：set /p stringName=这里用于提示用户输入的信息->`，这段代码可以显示输入的提示信息，通过`%stringName%`可取得用户输入的字符串信息。

**提示：**`set /a`是设置数值变量，`set /p`是提示用户输入。





### 批处理的复杂命令

> if、for

#### if命令
if命令判断程序执行时条件是否满足，如果满足就执行一个操作，不满足就执行另一种操作，条件可以是单个，也可以是多个的。根据if命令判断的对象，可将其分为三类：

1. **输入判断**
   用法为：`IF [NOT] "string1" == "string2" (...)`

   > 在批处理执行时，可以为其赋予一个或多个参数，如何根据输入参数的不同来决定批处理执行不同的命令呢？使用if命令的输入判断就可以实现。
2. **存在判断**
   用法为：`IF [NOT] EXIST fileName (...)`

   > 该用法可以为if命令指定一个文件名，当该文件存在时判断结果为真，否则为假。

3. **结果判断**
   用法为：`IF [NOT] ERRORLEVEL number (...)`

   > 由于DOS命令在执行完毕后都会给系统一个返回值，用来表示执行结果。在if命令中设置一个比较值，如果返回值大于或等于比较值就继续执行，否则就退出if命令。也可以在if后面仅跟一个not来判断“如果不……就……”，用法跟“如果……就……”的用法一样。

**注意：**在if当中是无法使用cd..将目录设置成上一级来操作。

**注意：**if判断文件是否存在的时候文件名不能带路径，或者说if只能判断当前文件夹中的文件是否存在，如果要判断其他文件夹的要使用cd命令切换当前工作的路径。



#### for命令
for命令是批处理中最具程序特点的命令，它是一个循环命令，用来对多个目标执行同一个操作，通常情况下是对一个或一组文件中的每一个对象进行定义的操作，直到所有对象都执行这一操作完成，或被强制终止。
for命令的基本用法为：

```powershell
for %variable in (set) do (...)

(set):定义要操作目标的范围
%variable:表示一个可在(set)定义的范围内取值的变量
(...):指定要执行的操作
in,do:为该命令中必不可少的关键字
```
for命令的执行过程，实际上是对`(set)`指定范围内的每一个对象执行`(...)`中定义的命令。

根据在`(set)`部分定义的操作对象的不同，可将for命令的作用分为四类：
1. **目录操作**：

   该操作只针对定义范围内的目录进行，执行时要使用**`/d`**参数

   > 假设要在当前目录中建立文件名分别为a、b、c的三个目录，则执行如下命令：`for /d %i in (a,b,c) do md %i`。该过程相当于依次执行`md a`、`md b`和`md c`。
   >
   > 如果在`(set)`中使用\*作为通配符，则可以设置操作对象为当前目录下的所有文件夹，也可以使用?符号来指定部分名称的文件夹为操作对象。
   >
   > 如果要删除上述的三个目录则可执行：`for /d %i in (*) do rd %i`。

2. **目录树操作**
   该操作针对指定的根目录树的每一层子目录进行for命令，执行时需要使用**`/r`**参数

   > 如果没有指定目录，则默认为当前目录。
   >
   > 假设要查看指定目录中的所有目录及子目录中的文件详细信息，则执行如下命令：`for /r e:\games %i in (.) do dir %i > info.txt`。这样相当于在每个目录及子目录中都执行了dir命令，然后将所有的执行结果都写到info.txt文件中。

3. **数值范围操作**
   该操作通过对`(set)`部分的特殊指定，可以生成一个数字序列来作为`(...)`的执行范围，执行时需要使用**`/l`**参数

   > 假设要生成所有三位数的有序序列，则可以利用for命令的/l参数方便实现。
   >
   > ```powershell
   > @echo off 
   > for /l %%i in (100,1,999) do echo %%i >> number.txt 
   > if errorlevel 0 echo All done. 
   > ```
   >
   >
   > 这样就将100到999之间所有的数字按递增顺序写到number.txt中，每行一个数字。在该操作的`(set)`部分中，前、后两个数字指定数字序列的最小和最大值，中间的数字代表生成序列的方式，1代表递增，-1代表递减。若将`(set)`中的100和999互换位置，会将100到999之间的数按递减顺序排列并写到number.txt文件中。

4. **文件解析**
   该操作是for命令最难最烦琐的操作，用来对定义范围内的文件内容、字符串以及其他命令的输出进行处理，执行时要使用**`/f`**参数

   > 要01.txt文件中的所有空行去掉，则执行如下命令：`for /f %i in (01.txt) do echo %i >> 02.txt`。这样就会将01.txt内容中不为空的所有行写入到02.txt文件中，因为`/f`参数默认不处理文件中的空行。
   >
   > 在该操作中，可以为`/f`参数再带上更多选项来实现更丰富的功能。在选项中可以定义被处理文件的其他条件，例如从第n行开始处理、行结尾如果是指定字符就跳过、指定每行的第那些字符被参数取代等。

**注意：**在for命令中，变量可以使用除`%0-%9`以外的所有**单个的**数字和字母，例如`%i`，而`%iii`则无效。同时变量有大小写之分，**%i不等于%I**。

**注意：**当要在批处理中执行for命令时，变量前要加两个%符号，否则会提示出错。例：`%%i`。





### 批处理的组合命令

> &、&&、||、|

#### &命令
&命令是最简单的组合命令，它的作用是连接多条子命令。不管前面的命令是否执行成功，后面的命令都将按顺序依次执行完毕。用法为：`COMMAND1 & COMMAND2 & COMMAND3...`

`del a.tmp & echo All done! & pause`	前面例子中的这句命令由三条子命令组成，它们依次执行，任何一个命令的执行结果都不影响其他子命令的执行。



#### &&命令

&&命令也是用来连接多条子命令的，用法与&命令相同，不同之处在于，它在从前往后依次执行被它连接的几个子命令时会自动判断是否有子命令执行出错，一旦发现某个子命令执行出错，该子命令后面的全部命令都将被忽略。这样，将某些在特定条件下不必执行的命令用&&命令连接在它的条件后面，当条件不正确时就不执行后面的命令了。

`例子：dir file://IP/www/user.mdb && copy file://IP/www/user.mdb e:\backup\user.mdb`	前面例子中先用dir命令查看远程主机上user.mdb文件是否存在，执行成功后（文件存在）就用copy命令复制到本地，否则不执行copy命令。



#### ||命令

||命令同样用来连接多条子命令，用法同前两种组合命令完全一样，但它的作用跟&&命令刚好相反，当多条子命令中只要有一个可以成功执行（&&命令是执行出错），后面的所有子命令将被忽略。

```powershell
例子：
dir 01.exe || dir 02.exe || echo No virus found! & pause
echo Found Virus! & goto clean
```

上面例子中，假设01.exe和02.exe是同一个病毒的两个文件，先用dir 01.exe命令检查文件01.exe是否存在，如果不存在（执行不成功）就继续执行dir 02.exe检查02.exe是否存在，如果存在01.exe就显示发现病毒，并跳转程序到清除病毒部分。



#### |命令(管道命令)

管道命令用来实现将一个命令的输出信息和另一个命令的输入相连接，类似与从管道中传递实体。用户只能看到最后的结果而不能看到它们之间通信的过程，因为这个过程是在管道中进行的。在批处理中使用管道命令，可以让命令之间互相通信，而将中间过程透明化，因此作用十分巨大。

`例子：type code.txt | debug`	前面例子中，想将一个保存在code.txt中的代码让debug程序来执行，不必先打开debug，再将code.txt的内容粘贴在里面后执行，只需要利用这个管道命令就可以实现。先用type命令在内存中显示code.txt的内容（type命令的输出），然后将这些输出作为debug的输入内容传递给debug。





### 批处理的重定向命令

> \> 和>>、<、>&和<&

#### >和>>命令
\>和>>命令又被称为输出重定向命令，它们的作用是一样的，都是将前一命令的输出写到一个文件中。在批处理中，它们往往被用来将某些信息保存到一个文件中。

\>命令和>>命令的不同之处在于：**前者是从文件的第一行开始覆盖，而后者是从文件的最后一行开始追加**。



#### <、<&和>&命令

`<`	输入重定向命令，从文件中读入命令输入，而不是从键盘中读入。

`>&`	将一个句柄的输出写入到另一个句柄的输入中。

`><&`	刚好和>&相反，从一个句柄读取输入并将其写入到另一个句柄输出中。





### 批处理的其他应用

#### 批处理参数的应用

参数在批处理中的应用十分广泛，很多情况下如果不使用参数，其功能将无法完成。参数中，`%0`表示该批处理文件名，相当于对该批处理自身的一次调用；`%1-%9`表示在执行时用加入的参数代替。如果参数多于9个，则需要使用shift命令来处理多出的参数。



#### 批处理操作注册表

一般情况下，操作注册表的方法是直接打开注册表编辑器对其操作，还有一种是利用导入的方法来操作注册表，将要编辑的注册表内容写到一个文件中，然后将该文件执行导入内容。使用批处理也可以对注册表进行操作，利用的原理就是导入。 

**注意：**echo命令后不空格而紧跟一个小圆点，作用是显示一个空行，且显示空行的前提是必须执行过echo off命令。.reg文件第二行和最后一行的两个空行必须存在，它是注册表文件的固定格式。

**警告：**注册表包含了计算机中每个用户的配置文件、有关系统硬件的信息、安装的程序及属性设置，Windows 在其运行中不断引用这些信息。在操作注册表前最好先对其进行备份，以免因操作不当造成难以预测的后果。





### 其他内容

#### 终止批处理
可以在键盘上按下**Ctrl+C**组合键来强行终止一个批处理的执行过程。



#### 环境变量
“环境变量”，是指包含诸如驱动器、路径或文件名之类的字符串，它控制着各种程序在执行时的外部环境，如临时文件位置等。可以使用**控制面板-->系统-->高级-->环境变量**或使用**set命令**对环境变量进行修改。

#### 可执行文件的优先级
在DOS环境下，可执行文件的优先级**由高到低依次为.com>.exe>.bat>.cmd**，即如果在同一目录下存在文件名相同的这四类文件，当只键入文件名时，DOS执行的是name.com，如果需要执行其他三个文件，则必须指定文件的全名，如name.bat。



#### if判断不存在的目录
if命令的存在判断不能用来判断一个目录是否存在，只能判断文件，但在每个目录下都存在空设备，因此可以使用判断空设备是否存在的方式来间接判断目录是否存在。方法为：`IF [NOT] EXIST [drive:][path]\nul command`。例如：`if not exist e:\tools\con md e:\tools`，如果不存在`e:\tools`这个目录就新建立一个。



#### 命令的帮助手册
几乎任何一个DOS命令都可以在命令提示符下输入`命令名 [/? | more]`来查看其帮助。 



#### 内部命令
内部命令是指包括在command.com（98系统）或cmd.exe（98以上系统）里的命令。比如你打开CMD命令行，输入help并回车，显示出来的所有命令都是内部命令，它们都被包括在cmd.exe这个文件里了。外部命令是指有独立文件的命令，比如net和ping命令都是外部命令，在system32目录下可以找到net.exe和ping.exe文件。 



#### 管道
操作系统中把“管道”定义为连接一个读进程和一个写进程以实现它们之间通信的文件，这个“文件”是在内存中建立的，当信息传递结束后它也随之消失，所以是不可见的。



#### 运行乱码
bat文件右键用“编辑”打开，另存为时，UTF-8保存为ANSI 格式。即可解决运行是乱码问题。







## 批处理模板和参照内容整理

> 此部分内容为自己使用批处理时总结的一些经验和模板，在开发中用来参考和代码复用

### 参考资料部分

#### 颜色表

>颜色属性由两个十六进制数字指定，第一个对应于背景，第二个对应于前景。

| 代码 | 含义   | 代码 | 含义     |
| ---- | ------ | ---- | -------- |
| 0    | 黑色   | 8    | 深灰色   |
| 1    | 深蓝色 | 9    | 亮蓝色   |
| 2    | 绿色   | A    | 亮绿色   |
| 3    | 天蓝色 | B    | 亮天蓝色 |
| 4    | 红色   | C    | 亮红色   |
| 5    | 紫色   | D    | 亮紫色   |
| 6    | 黄色   | E    | 亮黄色   |
| 7    | 灰色   | F    | 亮白色   |



#### 路径对照表

> 测试路径：D:\tool\nginx\stop.bat

| 路径符号     | 路径解释              | 使用效果                                              |
| ------------ | --------------------- | ----------------------------------------------------- |
| %0           | 批处理文件自身        | D:\tool\nginx\stop.bat                                |
| %~0          | 全路径                | D:\tool\nginx\stop.bat                                |
| %~f0         | 全路径（file）        | D:\tool\nginx\stop.bat                                |
| %~d0         | 盘符（dir）           | D:                                                    |
| %~p0         | 路径-无盘符（path）   | \tool\nginx                                           |
| %~n0         | 文件名称（name）      | stop                                                  |
| %~x0         | 后缀名（exe）         | .bat                                                  |
| %~s0         | 全路径（Short）       | D:\tool\nginx\stop.bat                                |
| %~a0         | 文件属性（attribute） | --a------                                             |
| %~t0         | 文件修改日期（time）  | 2017-03-30 15:10                                      |
| %~z0         | 文件大小（Size）      | 696                                                   |
| %~$PATH:0    | 全路径                | D:\tool\nginx\stop.bat                                |
| **%~dp0**    | **所在文件夹**        | **D:\tool\nginx\\**                                   |
| %~nx0        | 文件全称              | stop.bat                                              |
| %~fs0        | 全路径                | D:\tool\nginx\stop.bat                                |
| %~dp$PATH:0  | 文件夹                | D:\tool\nginx\                                        |
| %~ftza0      | 文件所有信息          | --a------ 2017-03-30 15:10 696 D:\tool\nginx\stop.bat |
| %1           | 第一个附加参数        |                                                       |
| %2           | 第二个附加参数        |                                                       |
| cd /d [path] | 可直接跳转到其他盘符  |                                                       |



#### 系统内置变量

> 批处理中可直接使用，变量中的具体路径来自于环境变量中设定的路径，如修改过环境变量的值，产生的路径自然也会不一样

| 变量                  | 所指路径                                                     |
| --------------------- | ------------------------------------------------------------ |
| %ALLUSERSPROFILE%     | C:\Documents and Settings\All Users                          |
| %USERPROFILE%         | C:\Documents and Settings\当前用户名                         |
| %HOMEPATH%            | C:\Documents and Settings\当前用户名                         |
| %SYSTEMROOT%          | C:\WINDOWS                                                   |
| %WINDIR%              | C:\WINDOWS                                                   |
| %ComSpec%             | C:\WINDOWS\System32\cmd.exe                                  |
| %APPDATA%             | C:\Documents and Settings\当前用户名\Application Data        |
| %ALLAPPDATA%          | C:\Documents and Settings\All Users\Application Data         |
| %SYSTEMDRIVE%         | C:                                                           |
| %HOMEDRIVE%           | C:                                                           |
| %TEMP% 和 %TMP%       | C:\Documents and Settings\当前用户名\Local Settings\Temp     |
| %ProgramFiles%        | C:\Program Files                                             |
| %CommonProgramFiles%  | C:\Program Files\Common Files                                |
| %systemdrive%         | Windows系统所在磁盘分区，通常就是C盘的根目录                 |
| %systemroot%,%windir% | Windows系统所在的目录，通常是C:\Winows                       |
| %programfiles%        | 通常情况下是C:\program files                                 |
| %commonprogramfiles%  | 公用文件目录，通常是C:\program files\common files            |
| %userprofile%：       | 当前账户的用户目录，通常是C:\documents and settings\当前用户名 |
| %alluserprofile%：    | 所有用户的用户目录，通常是C:\documents and settings\all user |
| %temp%,%tmp%：        | 当前用户的临时文件目录，通常是C:\documents and settings\当前用户名\local settings\temp |



#### 比较符

| 符号 | 含义       |
| ---- | ---------- |
| EQU  | 等于       |
| NEQ  | 不等于     |
| LSS  | 小于       |
| LEQ  | 小于或等于 |
| GTR  | 大于       |
| GEQ  | 大于或等于 |

用法：`if !value! EQU 1 (...)`



#### 代码页

> 设置代码页为GBK：`chcp 936`，直接输入chcp可以查看当前的代码页，当bat文件的编码格式为UTF-8时，要设置代码页为UTF-8才能正常显示，不然会出现乱码

| 代码  | 含义                           |
| ----- | ------------------------------ |
| 936   | 中国-简体中文（GB2312）（默认) |
| 1200  | Unicode                        |
| 1201  | Unicode(Big-Endian)            |
| 52936 | 简体中文（HZ）                 |
| 65001 | Unicode(UTF-8)                 |

**注意：**window的记事本的UTF-8格式会产生一个BOM的开头，这个开头看不见，但是会影响bat文件的运行，产生编码错误，所以如果bat文件的编码格式要设置成UTF-8的话一定要其他软件将bat文件保存为无BOM头的才能运行正常，同理，即使是普通的txt文档，如果文件的编码格式设置成了UTF-8那么也要用其他软件将文档存储为无BOM头的形式，不然可能会造成读取出现乱码的情况。



#### 字符串截取

> @echo  off
> Set  var=1234567890

| 代码                | 解释                                                  |
| ------------------- | ----------------------------------------------------- |
| `echo %var:~1%`     | 表示舍弃var的前1位。输出结果：234567890               |
| `echo %var:~0,1%`   | 表示舍弃var的前0位之后取1位。输出结果：1              |
| `echo %var:~1,1%`   | 表示舍弃var的前1位之后取1位。输出结果：2              |
| `echo %var:~0,-1%`  | 表示舍弃var的前0位和最后1位。输出结果：123456789      |
| `echo %var:~1,-3%`  | 表示舍弃var的前1位和最后3位。输出结果：234567         |
| `echo %var:~-1%`    | 表示取var的最后1位。输出结果：0                       |
| `echo %var:~-4,3%`  | 表示从var的倒数4位开始取3位。输出结果：789            |
| `echo %var:~-8,-2%` | 表示从var的倒数8位开始并舍弃最后2位。输出结果：345678 |

在set语句中`:`和`~`同时使用时，`:`起到截取字符串的功能。假设`set str=abcde`，那么，`set var=%str:~0,1%`表示截取字符串abcde的第一个字符。
和`=`同时使用时，起到替换字符串的功能。假设：`set str=abc:de`，那么，`set var=%str:a=1%`则表示把字符串`abc:de`中的`a`替换为`1`，`set var=%str::=2%`则表示把字符串`abc:de`中的`:`替换为`2`。





### 复用模板部分

#### 文件头格式

```powershell
@echo off
setlocal enabledelayedexpansion ::此行用来打开延迟变量

rem -------------------------------------
rem Author: Guan Lipeng
rem Date: ?/?/?
rem Description: 
rem -------------------------------------

title 这是批处理的窗口名字
mode con: cols=50 lines=16 ::此行用来控制窗口的大小
color fc ::此行用来控制窗口的颜色

echo. ::此行会输出一个空行
pause ::此行用来让程序暂停

exit
```



#### 关闭回显
有些语句运行后会显示操作信息，例如copy语句，可以在语句的最后面加上`>nul`，类似于`pause`后面加`>nul`，可以不显示消息提示。



#### 新建一个空的txt

```powershell
echo off>1.txt
```



#### 让提示在一行上显示
```powershell
@echo off
set /p ="hello "<nul
set /p =world<nul
echo !
pause >nul

输出结果：hello world!
```

**提示：**echo的作用是输出一个`!`并换行，如果不用echo，则下一行的提示内容依旧会跟着前面的内容继续，不会换行。



#### 控制程序延迟运行

```powershell
choice /t 2 /d y /n >nul
```

**/c**按键列表	**/m**提示内容	**/d**默认选择	**/t**等待秒数 ，其中：**/d**必须和**/t**同时出现



#### 设置数值变量
```powershell
set /a flag=123+4
```
在set后面加上`/a`可以将变量变为数值型，并能完成一些简单的加减运算和自增(`set /a flag+=1`)自减(`set /a flag-=1`)运算



#### 延迟变量

若要在程序中使用延迟变量，程序最开头要加上：`setlocal enabledelayedexpansion`，使用延迟变量时要用**`!`**，例如：`if !flag! == 1 (...)`
**解释：**批处理为多行代码同时处理，所以变量产生改变并不会立马在后面代码中应用，后面程序使用变量时依旧是用的初始值，故需要用到**`!`**来标记变量，告诉程序此变量为延迟变量，值可能已被改变，不可直接使用初始值。
**注意：**如果**赋值变量**时，内容包含**感叹号**（`!`），那么感叹号将被解析，导致赋值后的结果产生错误，例如：`aa!bb`，最终赋值后的可能就是`aabb`或`aa`，最终导致出错。此时可以使用`setlocal disabledelayedexpansion`来先关闭延迟变量，赋值完成后，再打开延迟变量，便可正常使用了。



#### 清除某个文件夹中的指定文件

```powershell
rd /s /q %~dp0%\"文件夹名称"
```



#### if对数字进行比较

使用`/i`或`/I`参数可进行数字间的比较

```powershell
SET /A var=1
IF /I "%var%" EQU "1" ECHO 变量等于1
```

| 比较符 | 释义 | 比较符 | 释义       |
| ------ | ---- | ------ | ---------- |
| EQU    | 等于 | NEQ    | 不等于     |
| LSS    | 小于 | LEQ    | 小于或等于 |
| GTR    | 大于 | GEQ    | 大于或等于 |



#### for的文件操作

```powershell
for /f "usebackq" "skip=1 eol=; tokens=1,2,3,4 delims=," %%a in (1.txt) do (echo %%a %%b %%c %%d)
```

| 参数       | 含义                                                         |
| ---------- | ------------------------------------------------------------ |
| usebackq   | 允许文件名中有空格，例：for /f "usebackq" %%i in ("文件名") do („„)，和skip这些关键词不可同时出现 |
| skip=1     | 忽略几行，在这里表示文本开始忽略的行数为1                    |
| eol=;      | 忽略以分号打头的行                                           |
| tokens=2,3 | 将每行中的第二个和第三个符号传递给for程序体，并且可以写成`tokens=1,2,5-7` 或`tokens=1,2,3*`或`tokens=1,2,5,7`分别表示取第1,2,5,6,7（依次赋给`%c`，`%d`，`%e`，`%f`，`%g`共5个变量）、1,2,3及3后的所有段（要赋给3个变量）、1,2,5,7(要赋给4个变量)，`tokens=`后的数字号可以不按顺序，但书写的顺序与分配给变量的顺序是对应的，这是赋值，至于之后do命令中用不用是另一回事。 |
| delims=,   | 用逗号做定界符号（分割字母的符号），也可以用其他符号做分割符，例如空格或一个Tab等（可以有多字符组合，之间也不能加空格，被理解为多项单个字符，如要空格符须放最后） |



#### 进程处理

```powershell
:: 查看所有进程的完整信息
netstat -ano

:: 查看指定端口的进程
netstat -ano|findstr 3033

:: 杀死指定程序
taskkill /pid 11588

:: 强制终止
taskkill /F /pid 11588
```



#### 字符串处理

开头部分的代码如下：

```powershell
@echo off
set "str=   ab c&>!   "
```

**去掉左侧空格-方法1**

```powershell
for /f "tokens=*" %%i in ("%str%") do echo "%%i"
```

**去掉左侧空格-方法2**

```powershell

:intercept
if "%str:~0,1%"==" " set "str=%str:~1%"&goto intercept
echo "%str%"
```



**去掉右侧空格-方法1**

```powershell
for /f "delims=" %%i in ("%str%") do echo "%%~nxi"
```

**去掉右侧空格-方法2**

```powershell
:intercept
if "%str:~-1%"==" " set "str=%str:~0,-1%"&goto intercept
echo "%str%"
```



**去掉首尾空格-方法1**

```powershell
for /f "tokens=*" %%i in ("%str%") do echo "%%~nxi"
```

**去掉首尾空格-方法2**

```powershell
:intercept_left
if "%str:~0,1%"==" " set "str=%str:~1%"&goto intercept_left

:intercept_right
if "%str:~-1%"==" " set "str=%str:~0,-1%"&goto intercept_right
echo "%str%"
```



**去掉所有空格**

```powershell
set "str=%str: =%"
echo "%str%"
```



#### 获取当前时间

```
格式： %date%
结果： 2016/11/29 周二

格式： %time%
结果： 8:16:17.43

自定义格式： %date:~x,y%以及%time:~x,y%
说明： x是开始位置，y是取得字符数
```
